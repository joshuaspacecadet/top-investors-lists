<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Top Investors | Spacecadet</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="/styles.css" />
  </head>
  <body
    data-base="appNWh4J1hBABWC6J"
    data-table="tblOqtOhWAfA9fWaR"
    data-view="viwsSmHXp0rEeut2R">

    <aside class="left-rail" aria-label="Brand rail">
      <div class="rail-top">
        <img src="https://spacecadet.ventures/wp-content/themes/spacecadet-ventures/asset/icon/star-mark.svg" alt="" />
      </div>
      <div class="rail-body">
        <div class="rail-text"><span class="rail-strong">Spacecadet:</span>  The Marketing VC</div>
      </div>
      <div class="rail-divider" aria-hidden="true"></div>
      <div class="rail-bottom">
        <img src="https://spacecadet.ventures/wp-content/themes/spacecadet-ventures/asset/icon/globe-mark.svg" alt="" />
      </div>
    </aside>

    <header class="site-header" role="banner">
      <div class="site-header__inner">
        <nav class="top-nav" aria-label="Primary">
          <a href="https://spacecadet.ventures/">Home</a>
          <a href="https://spacecadet.ventures/marketing">Marketing</a>
          <a href="https://spacecadet.ventures/mission">Mission</a>
          <a href="https://spacecadet.ventures/crew">Crew</a>
          <a href="https://spacecadet.ventures/portfolio">Portfolio</a>
        </nav>
        <a class="contact-link" href="mailto:greetings@spacecadet.ventures" aria-label="Get in touch">
          <span class="contact-label">Get in touch</span>
          <span class="icon-circle" aria-hidden="true">
            <img src="https://spacecadet.ventures/wp-content/themes/spacecadet-ventures/asset/icon/arrow-forward.svg" width="16" height="16" alt="" />
          </span>
        </a>
      </div>
    </header>

    <main id="main" class="content" role="main">
      <div class="hero">
        <h1 class="hero-headline">Top 3 Aerospace Seed Investors</h1>
        <div class="hero-bottom">
          <div class="hero-content">
            <p class="hero-copy">Identifying appropriate investors is hard. Here's a curated list of Seed investors (in alphabetical order) who actually lead rounds.</p>
          </div>
          <div class="hero-image">
            <img src="/Assets/handshake.jpg" alt="Handshake" />
          </div>
        </div>
      </div>
      <div class="divider">
        <img src="/Assets/union.svg" alt="" class="divider-star" />
        <div class="divider-line"></div>
      </div>
      <div id="records" class="records"></div>
      <p class="note">Click the button to create a Google Sheet in <em>your</em> Drive from the live Airtable view.</p>
      <button id="copyBtn">Copy to Google Sheets</button>
    </main>

    <script>
      // PUT YOUR CLIENT ID HERE (from Google Cloud Console)
      const GOOGLE_CLIENT_ID = "964428463207-81190lnabk68t0cbcgb5sbab5bss6tp1.apps.googleusercontent.com";

      // OAuth scopes needed to create + write a Sheet in the user's Drive
      const SCOPES = "https://www.googleapis.com/auth/spreadsheets";

      function getAccessToken() {
        return new Promise((resolve, reject) => {
          const client = google.accounts.oauth2.initTokenClient({
            client_id: GOOGLE_CLIENT_ID,
            scope: SCOPES,
            callback: resp => {
              if (resp && resp.access_token) resolve(resp.access_token);
              else reject(new Error("No access token"));
            }
          });
          client.requestAccessToken();
        });
      }

      async function createSheet() {
        const accessToken = await getAccessToken();

        const el = document.body.dataset;
        const payload = {
          base:  el.base,
          table: el.table,
          view:  el.view,
          namePrefix: "Top Investors Lists — Aerospace"
        };

        const res = await fetch("/.netlify/functions/new-sheet", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${accessToken}`
          },
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "Failed to create Sheet");
        window.open(data.url, "_blank");
      }

      document.getElementById("copyBtn").addEventListener("click", async () => {
        const btn = document.getElementById("copyBtn");
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = "Creating Sheet…";
        try {
          // run OAuth + fetch as before
          const accessToken = await getAccessToken();
          const el = document.body.dataset;
          const payload = {
            base:  el.base,
            table: el.table,
            view:  el.view,
            namePrefix: "Top Investors Lists — Aerospace"
          };
          const res = await fetch("/.netlify/functions/new-sheet", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${accessToken}`
            },
            body: JSON.stringify(payload)
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || "Failed to create Sheet");
          // navigate current tab to the new Sheet
          window.location.href = data.url;
        } catch (e) {
          alert("Copy failed: " + (e.message || e));
          btn.disabled = false;
          btn.textContent = originalText;
        }
      });

      // SWR-style local cache for instant render + background refresh
      const SWR_CACHE_VERSION = "v1";
      function getCacheKey(base, table, view) {
        return `records:${SWR_CACHE_VERSION}:${base}:${table}:${view}`;
      }
      function readCache(key) {
        try {
          const raw = localStorage.getItem(key);
          if (!raw) return null;
          return JSON.parse(raw);
        } catch (_) {
          return null;
        }
      }
      function writeCache(key, records) {
        try {
          const payload = { ts: Date.now(), records };
          localStorage.setItem(key, JSON.stringify(payload));
        } catch (_) {}
      }
      function renderRecords(container, records) {
        container.innerHTML = "";
        const toc = document.getElementById("toc");
        if (toc) toc.innerHTML = "";
        (records || []).forEach((r, i) => {
          const wrap = document.createElement("div");
          wrap.className = "record";
          wrap.id = `rec-${i+1}`;

          const info = document.createElement("div");
          info.className = "record-info";

          const idxEl = document.createElement("div");
          idxEl.className = "record-index";
          idxEl.textContent = String(i + 1).padStart(2, "0");
          info.appendChild(idxEl);

          const name = document.createElement("div");
          name.className = "record-name";
          name.textContent = (r.contactName || "").toUpperCase();
          info.appendChild(name);

          const fundLine = document.createElement("div");
          fundLine.className = "record-fund";
          const fundLink = document.createElement("a");
          fundLink.href = r.link || "#";
          fundLink.target = "_blank";
          fundLink.rel = "noopener";
          fundLink.textContent = r.fund || "Fund";
          fundLine.appendChild(fundLink);
          info.appendChild(fundLine);

          const check = document.createElement("div");
          check.className = "kv";
          const checkLabel = document.createElement("p");
          checkLabel.className = "kv-label";
          checkLabel.textContent = "Check Size:";
          const checkVal = document.createElement("p");
          checkVal.className = "kv-value";
          checkVal.textContent = r.checkSize || "";
          check.appendChild(checkLabel);
          check.appendChild(checkVal);
          info.appendChild(check);

          const focus = document.createElement("div");
          focus.className = "kv";
          const focusLabel = document.createElement("p");
          focusLabel.className = "kv-label";
          focusLabel.textContent = "Focus:";
          const focusVal = document.createElement("p");
          focusVal.className = "kv-value";
          focusVal.textContent = r.focus || "";
          focus.appendChild(focusLabel);
          focus.appendChild(focusVal);
          info.appendChild(focus);

          const advice = document.createElement("div");
          advice.className = "kv";
          const adviceLabel = document.createElement("p");
          adviceLabel.className = "kv-label";
          adviceLabel.textContent = "Pitch Advice:";
          const adviceVal = document.createElement("p");
          adviceVal.className = "kv-value";
          adviceVal.textContent = r.pitchAdvice || "";
          advice.appendChild(adviceLabel);
          advice.appendChild(adviceVal);
          info.appendChild(advice);

          wrap.appendChild(info);

          if (r.imageUrl) {
            const imgWrap = document.createElement("div");
            imgWrap.className = "record-image";
            const img = document.createElement("img");
            img.src = r.imageUrl;
            img.loading = "lazy";
            img.alt = r.contactName ? `${r.contactName} image` : "Investor image";
            imgWrap.appendChild(img);
            wrap.appendChild(imgWrap);
          }

          container.appendChild(wrap);

          // TOC entry
          if (toc) {
            const li = document.createElement("li");
            const a = document.createElement("a");
            a.href = `#rec-${i+1}`;
            a.textContent = r.contactName || r.fund || `Investor ${i+1}`;
            li.appendChild(a);
            toc.appendChild(li);
          }
        });
      }
      async function tryFetchForView({ base, table, view }) {
        const url = `/.netlify/functions/list-records?base=${encodeURIComponent(base)}&table=${encodeURIComponent(table)}&view=${encodeURIComponent(view)}`;
        const res = await fetch(url, { cache: "no-store" });
        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "Failed to load records");
        return (data.records || []);
      }
      async function fetchRecordsWithCandidates({ base, table, view }) {
        const candidates = generateViewCandidates(view);
        let lastError = null;
        for (const cand of candidates) {
          try {
            const records = await tryFetchForView({ base, table, view: cand });
            return { records, usedView: cand };
          } catch (e) {
            lastError = e;
          }
        }
        throw lastError || new Error("Failed to load records");
      }
      async function loadRecords() {
        const container = document.getElementById("records");
        const { base, table } = document.body.dataset;
        let { view } = document.body.dataset;
        const cacheKey = getCacheKey(base, table, view);
        const cached = readCache(cacheKey);
        if (cached && Array.isArray(cached.records) && cached.records.length) {
          renderRecords(container, cached.records);
          updateHero(view, cached.records.length);
        }
        try {
          const { records: fresh, usedView } = await fetchRecordsWithCandidates({ base, table, view });
          if (usedView && usedView !== view) {
            document.body.dataset.view = usedView;
            updateUrlForViewName(usedView);
            view = usedView;
            updateHero(usedView, fresh.length);
            updateSEO(usedView);
          } else {
            updateHero(view, fresh.length);
          }
          const newCacheKey = getCacheKey(base, table, view);
          const currentCached = readCache(newCacheKey);
          const changed = !currentCached || JSON.stringify(fresh) !== JSON.stringify(currentCached.records);
          if (changed) renderRecords(container, fresh);
          writeCache(newCacheKey, fresh);
        } catch (e) {
          if (!cached || !cached.records || !cached.records.length) {
            const error = document.createElement("p");
            error.className = "note";
            error.textContent = "Failed to load records.";
            container.appendChild(error);
          }
        }
      }

      // ----- Route <-> View mapping helpers -----
      const VIEW_SLUG_TO_NAME = {
        "aerospace-seed": "Aerospace Seed",
        "robotics-pre-seed": "Robotics Pre-Seed"
      };
      const DEFAULT_VIEW_NAME = "Aerospace Seed"; // fallback when initial data-view is an ID and no slug present
      function slugifyViewName(name) {
        if (!name) return "";
        return String(name)
          .trim()
          .toLowerCase()
          .replace(/[^a-z0-9\s-]/g, "")
          .replace(/\s+/g, "-")
          .replace(/-+/g, "-");
      }
      function titleizeFromSlug(slug) {
        return String(slug)
          .split("-")
          .map(w => w ? (w[0].toUpperCase() + w.slice(1)) : w)
          .join(" ");
      }
      function generateViewCandidates(input) {
        const raw = String(input || "").trim();
        const slug = slugifyViewName(raw);
        const tokens = slug.split("-").filter(Boolean);
        const candidates = [];

        // Helper: title-case each token, including hyphenated sub-parts
        const titleCaseToken = (t) => t.replace(/\b\w/g, c => c.toUpperCase());
        const titleCaseHyphenated = (s) => s.split("-").map(titleCaseToken).join("-");
        const titleCaseSpaced = (s) => s.split(" ").map(titleCaseToken).join(" ");

        // Helper: uppercase tokens of length <= 2 (e.g., AI, US, EU)
        const uppercaseShortTokens = (parts) => parts.map(p => (p.length <= 2 ? p.toUpperCase() : p));

        // 1) Direct mapping if provided
        if (VIEW_SLUG_TO_NAME[slug]) {
          candidates.push(VIEW_SLUG_TO_NAME[slug]);
        }

        // 2) Raw and simple transforms
        if (raw) candidates.push(raw);
        const allSpaced = tokens.join(" ");
        const allHyphen = tokens.join("-");
        candidates.push(allSpaced, allHyphen);

        // 3) Mixed: last-two hyphen, others spaced (handles "Pre-Seed")
        if (tokens.length >= 3) {
          const head = tokens.slice(0, -2).join(" ");
          const tail = tokens.slice(-2).join("-");
          candidates.push([head, tail].filter(Boolean).join(" "));
        }

        // 4) Title case variants
        candidates.push(titleCaseSpaced(allSpaced));
        candidates.push(titleCaseHyphenated(allHyphen));
        if (tokens.length >= 3) {
          const head = tokens.slice(0, -2).join(" ");
          const tail = tokens.slice(-2).join("-");
          candidates.push(titleCaseSpaced(head ? `${head} ${tail}` : tail));
        }

        // 5) Uppercase short tokens (<=2) variants on spaced/hyphen/mixed
        const upperShort = uppercaseShortTokens(tokens);
        const upperSpaced = upperShort.join(" ");
        const upperHyphen = upperShort.join("-");
        candidates.push(titleCaseSpaced(upperSpaced));
        candidates.push(titleCaseHyphenated(upperHyphen));
        if (tokens.length >= 3) {
          const headParts = upperShort.slice(0, -2);
          const tailParts = upperShort.slice(-2);
          const combo = [headParts.join(" "), tailParts.join("-")].filter(Boolean).join(" ");
          candidates.push(titleCaseSpaced(combo));
        }

        // Dedupe while preserving order and drop falsy
        return Array.from(new Set(candidates.filter(Boolean)));
      }
      function getSlugFromPath() {
        const path = window.location.pathname;
        const match = path.match(/\/resources\/top-investor-lists\/([^\/?#]+)/i);
        if (match && match[1]) return decodeURIComponent(match[1]);
        const parts = path.replace(/\/+$/,"").split("/");
        const tail = parts[parts.length - 1];
        if (tail && tail !== "" && tail !== "index.html") return decodeURIComponent(tail);
        return null;
      }
      function buildPathWithSlug(slug) {
        const path = window.location.pathname;
        const baseMatch = path.match(/^(.*\/resources\/top-investor-lists)\/?/i);
        const base = baseMatch ? baseMatch[1] : path.replace(/\/+$/,"").split("/").slice(0, -1).join("/") || "";
        const prefix = base === "" ? "" : base;
        return `${prefix}/${slug}`;
      }
      function updateUrlForViewName(viewName) {
        const slug = slugifyViewName(viewName);
        if (!slug) return;
        const newPath = buildPathWithSlug(slug);
        const curPath = window.location.pathname;
        if (newPath !== curPath) {
          window.history.replaceState({}, "", newPath + window.location.search + window.location.hash);
        }
      }

      // ---- SEO helpers (dynamic per-view) ----
      function ensureMetaByName(name, content) {
        if (!name || !content) return;
        let el = document.querySelector(`meta[name="${name}"]`);
        if (!el) {
          el = document.createElement("meta");
          el.setAttribute("name", name);
          document.head.appendChild(el);
        }
        el.setAttribute("content", content);
      }
      function ensureMetaByProperty(property, content) {
        if (!property || !content) return;
        let el = document.querySelector(`meta[property="${property}"]`);
        if (!el) {
          el = document.createElement("meta");
          el.setAttribute("property", property);
          document.head.appendChild(el);
        }
        el.setAttribute("content", content);
      }
      function ensureLinkRel(rel, href) {
        if (!rel || !href) return;
        let el = document.querySelector(`link[rel="${rel}"]`);
        if (!el) {
          el = document.createElement("link");
          el.setAttribute("rel", rel);
          document.head.appendChild(el);
        }
        el.setAttribute("href", href);
      }
      function ensureJsonLd(id, obj) {
        let el = document.getElementById(id);
        const json = JSON.stringify(obj);
        if (!el) {
          el = document.createElement("script");
          el.type = "application/ld+json";
          el.id = id;
          el.text = json;
          document.head.appendChild(el);
        } else {
          el.text = json;
        }
      }
      function updateSEO(viewName) {
        if (!viewName) return;
        const slug = slugifyViewName(viewName);
        const canonicalPath = buildPathWithSlug(slug);
        const canonicalUrl = `${window.location.origin}${canonicalPath}`;
        const title = `Top ${viewName} Investors | Spacecadet`;
        const description = `Curated list of ${viewName} investors who lead rounds. Export to Google Sheets.`;
        const image = `${window.location.origin}/Assets/handshake.jpg`;

        document.title = title;
        ensureMetaByName("description", description);

        ensureMetaByProperty("og:type", "website");
        ensureMetaByProperty("og:title", title);
        ensureMetaByProperty("og:description", description);
        ensureMetaByProperty("og:url", canonicalUrl);
        ensureMetaByProperty("og:image", image);

        ensureMetaByName("twitter:card", "summary_large_image");
        ensureMetaByName("twitter:title", title);
        ensureMetaByName("twitter:description", description);
        ensureMetaByName("twitter:image", image);

        ensureLinkRel("canonical", canonicalUrl);

        ensureJsonLd("ld-collection", {
          "@context": "https://schema.org",
          "@type": "CollectionPage",
          "name": title,
          "description": description,
          "url": canonicalUrl,
          "isPartOf": {
            "@type": "WebSite",
            "name": "Spacecadet",
            "url": window.location.origin
          }
        });
      }

      // Update hero headline and copy to reflect current view
      function updateHero(viewName, count) {
        const headline = document.querySelector('.hero-headline');
        const copy = document.querySelector('.hero-copy');
        if (headline && viewName) {
          const n = typeof count === "number" && count >= 0 ? count : null;
          headline.textContent = n != null ? `Top ${n} ${viewName} Investors` : `Top ${viewName} Investors`;
        }
        if (copy && viewName) {
          copy.textContent = `Identifying appropriate investors is hard. Here's a curated list of ${viewName} investors (in alphabetical order) who actually lead rounds.`;
        }
        // Re-run sizing for the headline after text change
        if (typeof requestAnimationFrame !== "undefined") {
          requestAnimationFrame(() => {
            if (typeof resizeHeadline === "function") {
              resizeHeadline();
            }
          });
        }
      }

      // Resolve view from URL slug (if present) → set dataset.view (by name), sync URL, then load
      let HAS_VIEW = false;
      (function initViewFromUrl() {
        const slug = getSlugFromPath();
        let viewNameFromUrl = null;
        if (slug) {
          viewNameFromUrl = VIEW_SLUG_TO_NAME[slug] || titleizeFromSlug(slug);
        }
        if (viewNameFromUrl) {
          document.body.dataset.view = viewNameFromUrl;
          updateUrlForViewName(viewNameFromUrl);
          updateHero(viewNameFromUrl);
          updateSEO(viewNameFromUrl);
          HAS_VIEW = true;
        } else {
          const main = document.getElementById("main");
          if (main) main.style.display = "none";
          HAS_VIEW = false;
        }
      })();

      if (HAS_VIEW) {
        loadRecords();
      }

      // Handle browser navigation to another slug on this page
      window.addEventListener("popstate", () => {
        const slug = getSlugFromPath();
        if (!slug) return;
        const viewName = VIEW_SLUG_TO_NAME[slug] || titleizeFromSlug(slug);
        if (viewName) {
          document.body.dataset.view = viewName;
          updateHero(viewName);
          updateSEO(viewName);
          const main = document.getElementById("main");
          if (main) main.style.display = "";
          HAS_VIEW = true;
          loadRecords();
        }
      });

      // Auto-resize headline to fit on one line
      function resizeHeadline() {
        const headline = document.querySelector('.hero-headline');
        if (!headline) return;
        
        // Use requestAnimationFrame to ensure layout is complete
        requestAnimationFrame(() => {
          // Measure against the headline's own content box to avoid underestimation
          const paddingLeft = parseInt(window.getComputedStyle(headline).paddingLeft);
          const paddingRight = parseInt(window.getComputedStyle(headline).paddingRight);
          
          const minFontSizeRem = 2; // 2rem minimum
          const maxFontSizeRem = 5; // 5rem maximum
          const step = 0.05; // Increment by 0.05rem for smoother resizing
          
          // Start at max size (5rem) to test
          headline.style.fontSize = maxFontSizeRem + 'rem';
          
          // Force a reflow to get accurate measurements
          headline.offsetHeight;
          
          let fontSizeRem = maxFontSizeRem;
          let contentWidth = headline.clientWidth; // excludes padding
          const availableWidth = contentWidth;     // available line width for the text
          
          // Only resize if it doesn't fit at max size
          if (headline.scrollWidth > availableWidth) {
            // Reduce font size incrementally until it fits
            while (fontSizeRem > minFontSizeRem && headline.scrollWidth > availableWidth) {
              fontSizeRem -= step;
              headline.style.fontSize = fontSizeRem + 'rem';
              // Force reflow for accurate measurement
              headline.offsetHeight;
              contentWidth = headline.clientWidth;
            }
            
            // Ensure it doesn't go below minimum
            if (fontSizeRem < minFontSizeRem) {
              headline.style.fontSize = minFontSizeRem + 'rem';
            }
          }
        });
      }

      // Resize after fonts load and page is ready
      function initResize() {
        if (document.fonts && document.fonts.ready) {
          document.fonts.ready.then(() => {
            requestAnimationFrame(() => {
              setTimeout(resizeHeadline, 200);
            });
          });
        } else {
          requestAnimationFrame(() => {
            setTimeout(resizeHeadline, 500);
          });
        }
      }

      if (document.readyState === 'loading') {
        window.addEventListener('DOMContentLoaded', initResize);
      } else {
        initResize();
      }
      
      let resizeTimeout;
      window.addEventListener('resize', () => {
        clearTimeout(resizeTimeout);
        resizeTimeout = setTimeout(() => {
          requestAnimationFrame(resizeHeadline);
        }, 100);
      });
    </script>
  </body>
</html>
