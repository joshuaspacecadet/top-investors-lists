<!doctype html>
<html>
  <head>
    <meta charset="utf-8" />
    <title>Top 3 Aerospace Seed Investors</title>
    <script src="https://accounts.google.com/gsi/client" async defer></script>
    <style>
      body { font-family: system-ui, Arial; padding: 24px; max-width: 720px; margin: 0 auto; background: #000; color: #fff; }
      button { padding: 10px 14px; border: 1px solid #dadce0; border-radius: 6px; cursor: pointer; }
      .note { color: #fff; }
      h1 { font-size: 32px; margin: 0 0 16px 0; }
      .records { display: flex; flex-direction: column; gap: 12px; margin: 16px 0 20px 0; }
      .record { display: flex; align-items: flex-start; gap: 16px; border: 1px solid #222; background: #0c0c0c; padding: 12px; border-radius: 8px; }
      .record-info { flex: 1; }
      .record-info p { margin: 0 0 6px 0; }
      .record-image img { width: 120px; height: 120px; object-fit: cover; border-radius: 6px; background: #111; border: 1px solid #222; }
    </style>
  </head>
  <body
    data-base="appNWh4J1hBABWC6J"
    data-table="tblOqtOhWAfA9fWaR"
    data-view="viwsSmHXp0rEeut2R">

    <h1>Top 3 Aerospace Seed Investors</h1>
    <div id="records" class="records"></div>
    <p class="note">Click the button to create a Google Sheet in <em>your</em> Drive from the live Airtable view.</p>
    <button id="copyBtn">Copy to Google Sheets</button>

    <script>
      // PUT YOUR CLIENT ID HERE (from Google Cloud Console)
      const GOOGLE_CLIENT_ID = "964428463207-81190lnabk68t0cbcgb5sbab5bss6tp1.apps.googleusercontent.com";

      // OAuth scopes needed to create + write a Sheet in the user's Drive
      const SCOPES = "https://www.googleapis.com/auth/spreadsheets";

      function getAccessToken() {
        return new Promise((resolve, reject) => {
          const client = google.accounts.oauth2.initTokenClient({
            client_id: GOOGLE_CLIENT_ID,
            scope: SCOPES,
            callback: resp => {
              if (resp && resp.access_token) resolve(resp.access_token);
              else reject(new Error("No access token"));
            }
          });
          client.requestAccessToken();
        });
      }

      async function createSheet() {
        const accessToken = await getAccessToken();

        const el = document.body.dataset;
        const payload = {
          base:  el.base,
          table: el.table,
          view:  el.view,
          namePrefix: "Top Investors Lists — Aerospace"
        };

        const res = await fetch("/.netlify/functions/new-sheet", {
          method: "POST",
          headers: {
            "Content-Type": "application/json",
            "Authorization": `Bearer ${accessToken}`
          },
          body: JSON.stringify(payload)
        });

        const data = await res.json();
        if (!res.ok) throw new Error(data.error || "Failed to create Sheet");
        window.open(data.url, "_blank");
      }

      document.getElementById("copyBtn").addEventListener("click", async () => {
        const btn = document.getElementById("copyBtn");
        const originalText = btn.textContent;
        btn.disabled = true;
        btn.textContent = "Creating Sheet…";
        try {
          // run OAuth + fetch as before
          const accessToken = await getAccessToken();
          const el = document.body.dataset;
          const payload = {
            base:  el.base,
            table: el.table,
            view:  el.view,
            namePrefix: "Top Investors Lists — Aerospace"
          };
          const res = await fetch("/.netlify/functions/new-sheet", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
              "Authorization": `Bearer ${accessToken}`
            },
            body: JSON.stringify(payload)
          });
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || "Failed to create Sheet");
          // navigate current tab to the new Sheet
          window.location.href = data.url;
        } catch (e) {
          alert("Copy failed: " + (e.message || e));
          btn.disabled = false;
          btn.textContent = originalText;
        }
      });

      async function loadRecords() {
        const container = document.getElementById("records");
        const { base, table, view } = document.body.dataset;
        try {
          const url = `/.netlify/functions/list-records?base=${encodeURIComponent(base)}&table=${encodeURIComponent(table)}&view=${encodeURIComponent(view)}`;
          const res = await fetch(url);
          const data = await res.json();
          if (!res.ok) throw new Error(data.error || "Failed to load records");

          (data.records || []).forEach(r => {
            const wrap = document.createElement("div");
            wrap.className = "record";

            const info = document.createElement("div");
            info.className = "record-info";

            const name = document.createElement("p");
            name.textContent = r.contactName || "";
            info.appendChild(name);

            const fundLine = document.createElement("p");
            const fundLink = document.createElement("a");
            fundLink.href = r.link || "#";
            fundLink.target = "_blank";
            fundLink.rel = "noopener";
            fundLink.textContent = r.fund || "Fund";
            fundLine.appendChild(fundLink);
            const after = document.createTextNode(r.link ? ` linked to ${r.link}` : "");
            fundLine.appendChild(after);
            info.appendChild(fundLine);

            const check = document.createElement("p");
            check.textContent = `Check Size: ${r.checkSize || ""}`;
            info.appendChild(check);

            const focus = document.createElement("p");
            focus.textContent = `Focus: ${r.focus || ""}`;
            info.appendChild(focus);

            const advice = document.createElement("p");
            advice.textContent = `Pitch Advice: ${r.pitchAdvice || ""}`;
            info.appendChild(advice);

            wrap.appendChild(info);

            if (r.imageUrl) {
              const imgWrap = document.createElement("div");
              imgWrap.className = "record-image";
              const img = document.createElement("img");
              img.src = r.imageUrl;
              img.alt = r.contactName ? `${r.contactName} image` : "Investor image";
              imgWrap.appendChild(img);
              wrap.appendChild(imgWrap);
            }

            container.appendChild(wrap);
          });
        } catch (e) {
          const error = document.createElement("p");
          error.className = "note";
          error.textContent = "Failed to load records.";
          container.appendChild(error);
        }
      }

      loadRecords();
    </script>
  </body>
</html>
